<!doctype html>



  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Python, Cython, Numba," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="Python is known for easy coding and calling c/c++ libraries. However, the first point is at the expense of executing speed. You also need to strictly follow Python instructions to call c/c++ libraries">
<meta property="og:type" content="article">
<meta property="og:title" content="Light Approaches for High-Efficiency Python">
<meta property="og:url" content="http://bywbilly.com/2017/10/09/Light-Approaches-for-High-Efficiency-Python/index.html">
<meta property="og:site_name" content="bywbilly">
<meta property="og:description" content="Python is known for easy coding and calling c/c++ libraries. However, the first point is at the expense of executing speed. You also need to strictly follow Python instructions to call c/c++ libraries">
<meta property="og:image" content="http://bywbilly.com/2017/10/09/Light-Approaches-for-High-Efficiency-Python/sum2dcpp.png">
<meta property="og:updated_time" content="2017-10-10T03:21:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Light Approaches for High-Efficiency Python">
<meta name="twitter:description" content="Python is known for easy coding and calling c/c++ libraries. However, the first point is at the expense of executing speed. You also need to strictly follow Python instructions to call c/c++ libraries">
<meta name="twitter:image" content="http://bywbilly.com/2017/10/09/Light-Approaches-for-High-Efficiency-Python/sum2dcpp.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"remove","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://bywbilly.com/2017/10/09/Light-Approaches-for-High-Efficiency-Python/"/>





  <title> Light Approaches for High-Efficiency Python | bywbilly </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  














  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">bywbilly</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Enjoy Yourself!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://bywbilly.com/2017/10/09/Light-Approaches-for-High-Efficiency-Python/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="bywbilly">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/photo.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="bywbilly">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="bywbilly" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Light Approaches for High-Efficiency Python
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-09T15:00:28-04:00">
                2017-10-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          
             <span id="/2017/10/09/Light-Approaches-for-High-Efficiency-Python/" class="leancloud_visitors" data-flag-title="Light Approaches for High-Efficiency Python">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">Views </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          

          

&nbsp; | &nbsp;
<span id="/2017/10/09/Light-Approaches-for-High-Efficiency-Python/"class="leancloud_visitors" data-flag-title="Light Approaches for High-Efficiency Python">
         &nbsp;Views
		         </span>
				 
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Python is known for easy coding and calling c/c++ libraries. However, the first point is at the expense of executing speed. You also need to strictly follow Python instructions to call c/c++ libraries.</p>
<p>So, here comes a question: Can we make Python run much faster? The answer is definitely <strong>YES</strong>!</p>
<p>Before introduce the light approaches to speed up Python, I want to show a little example – sum up a 2-dimension array.</p>
<p>Original Python:</p>
<pre><code>import numpy as np

def sum2d(arr):
       n, m = arr.shape
    ret = 0.0
    for i in xrange(n):
        for j in xrange(m):
            ret += arr[i, j]
    return ret
</code></pre><p>Python with Numba:</p>
<pre><code>from numba import jit
import numpy as np

@jit
def sum2d(arr):
    n, m = arr.shape
    ret = 0.0
    for i in xrange(n):
        for j in xrange(m):
            ret += arr[i, j]
    return ret
</code></pre><p>Cython:</p>
<pre><code>import numpy as np
cimport numpy as np
import cython

@cython.boundscheck(False)
@cython.wraparound(False)
cdef double _sum2d(np.ndarray[np.float32_t, ndim=2] arr):
    cdef int n, m
    n = arr.shape[0]
    m = arr.shape[1]
    cdef double ret = 0.0
    for i in range(n):
        for j in range(m):
            ret += arr[i, j]
    return ret

def sum2d(arr):
    return _sum2d(arr)
</code></pre><p>The three code snippets seem to be quite similar, but let’s see the running time.</p>
<pre><code>In [1]: import numpy as np

In [2]: from loop import sum2d as trivial_sum2d

In [3]: from loop_numba import sum2d as numba_sum2d

In [4]: from cloop import sum2d as cython_sum2d

In [5]: x = np.arange(100000000).reshape(1000, 100000).astype(np.float32)

In [6]: %timeit -n 10 -r 3 numba_sum2d(x)
10 loops, best of 3: 92.7 ms per loop

In [7]: %timeit -n 10 -r 3 cython_sum2d(x)
10 loops, best of 3: 93 ms per loop

In [8]: %timeit -n 10 -r 3 trivial_sum2d(x)
10 loops, best of 3: 27 s per loop
</code></pre><p>Numba and Cython’s running time are almost the same and it’s about 290 times faster than original Python. You may not believe me if I say that it runs even <strong>faster</strong> than trivial C++ code. Let’s do it!</p>
<p>Trivial C++:</p>
<pre><code>#include &lt;ctime&gt;
#include &lt;cstdlib&gt;
#include &lt;chrono&gt;
#include &lt;iostream&gt;

class Matrix {
    float *data;
public:
    size_t n, m;
    Matrix(size_t r, size_t c): data(new float[r*c]), n(r), m(c) {}
    ~Matrix() { delete[] data; }
    float&amp; operator() (size_t x, size_t y) { return data[x*m+y]; }
    float operator() (size_t x, size_t y) const { return data[x*m+y]; }
};

float sum2d(const Matrix &amp;a) {
    float ret = 0;
    for (size_t i = 0; i &lt; a.n; ++i) 
        for (size_t j = 0; j &lt; a.m; ++j) {
            ret += a(i, j);
        }
    return ret;
}

void fill(Matrix &amp;a) {
    int cnt = -1;
    for (size_t i = 0; i &lt; a.n; ++i)
        for (size_t j = 0; j &lt; a.m; ++j) {
            a(i, j) = ++cnt;
        }
}

int main() {
    srand((unsigned)time(NULL));
    const int n = 1000, m = 100000, T = 10;
    Matrix x(n, m);
    fill(x);
    auto st = std::chrono::system_clock::now();
    float s = 0;
    for (int i = 0; i &lt; T; ++i) {
        s += sum2d(x);
    }
    auto ed = std::chrono::system_clock::now();
    std::chrono::duration&lt;double&gt; diff = ed-st;
    std::cerr &lt;&lt; s &lt;&lt; std::endl;
    std::cout &lt;&lt; T &lt;&lt; &quot; loops. average &quot; &lt;&lt; diff.count() * 1e3 / T &lt;&lt; &quot;ms&quot; &lt;&lt; std::endl;
}
</code></pre><p>The results are amazing:</p>
<img src="/2017/10/09/Light-Approaches-for-High-Efficiency-Python/sum2dcpp.png" alt="Results" title="Results">
<p>You see, C++ is even slower. The reason may be that the excellent optimization of Numpy!</p>
<p>Through the example, we could believe that there are many <strong>Light-Approaches</strong> for speeding up Python code. I will introduce two popular tools in the next sections, <a href="https://numba.pydata.org/" target="_blank" rel="external"><strong>Numba</strong></a> and <a href="http://cython.org/" target="_blank" rel="external"><strong>Cython</strong></a>.</p>
<h2 id="Numba"><a href="#Numba" class="headerlink" title="Numba"></a>Numba</h2><p>Numba utilizes just-in-time(JIT) compilation, which could finish compilation during execution. So numba could <strong>infer the type</strong> of your Python object(variable) <strong>during your execution</strong>. People may ask here, why mainstream Python compiler do not support this feature? There are too many history problems here. Nowadays, the most popular python <em>Interpreter</em> is <a href="https://github.com/python/cpython" target="_blank" rel="external"><strong>CPython</strong></a> who uses a <a href="https://wiki.python.org/moin/GlobalInterpreterLock" target="_blank" rel="external">GIL</a>(GlobalInterpreterLock). Some minor <em>Interpreters</em> are trying to do these things, but they are still catching up, e.g <a href="https://pypy.org/" target="_blank" rel="external"><strong>PyPy</strong></a>.</p>
<p>The basic usage of Numba is to add function decorator <strong>@jit</strong> to let Numba itself decide how to deal with the function. </p>
<pre><code>from numba import jit

@jit
def sum(x, y):
    return x + y
</code></pre><p>You could also add signature for the function you want to speed up. Like:</p>
<pre><code>from numba import jit

@jit(numba.int32(numba.int32, numba.int32))
def sum(x, y):
    return x + y
</code></pre><p>You could also omit some type of the varibles, then Numba will try to infer them. Besides, you could pass a list of signature candidates.</p>
<pre><code>from numba import jit

@jit((numba.int32, numba.int32))
def sum(x, y):
    return x + y

# the type of x is int32 or float32
@jit(numba.float32(numba.int32(numba.int32, numba.float32), numba.int32))
def sum(x, y):
    return x + y
</code></pre><p>When you call or inline other functions, you need to make sure every corresponding functions have a <strong>jit</strong> decorator, or Numba may generate some code that runs slower than original one. Like in the example below, you <strong>cannot omit</strong> the decorator of the first function.</p>
<pre><code>from numba import jit

@jit
def sum(x, y):
    return x + y

@jit
def f(x, y, z):
    return z * sum(x, y) 
</code></pre><p>There are more optional arguments for the <strong>JIT</strong> decorator. I just want to introduce <strong>nopython</strong> and <strong>nogil</strong> detailed. You could pass these arguments like:</p>
<pre><code>from numba import jit

@jit(nopython=True)
def sum(x, y):
    return x + y

@jit(nogil=True)
def sum(x, y):
    return x + y
</code></pre><p><strong>nopython</strong> here means the Numba Compiler do not call any Python C API, but it requires that all the variables types do can be inferred. If not, Numba has to fall back. If yes, this mode could generate much faster code.</p>
<p><strong>nogil</strong> may not be the key point of this article, since I write it for the AI researchers. But this is a really excellent feature. With CPython(GIL), you cannot write any multi-threading code since it will execute even slower than single thread. But now, with nogil mode, you could do that! Numba will release the lock of GIL of that function.</p>
<p>Another important feature it support is the <strong>universal function</strong> that also important for numpy. You could see the <a href="https://docs.scipy.org/doc/numpy-1.13.0/reference/ufuncs.html" target="_blank" rel="external">numpy ufunc</a> for details. Basiclly, the idea is to apply some specific funtion highly parallel to each element of a matrix. You could use the example below, we want to add the same constant to each element of a vector.</p>
<pre><code>import numba

@numba.vectorize(&quot;numba.float32(numba.float32, numba.float32)&quot;, target=&quot;parallel&quot;, nopython=True)
def vec_add(x, c):
    return x + c
</code></pre><p>I don’t want to list too many similar codes with numba or without. I just report the results here. For a 10k vector, the Numba implemented <strong>ufunc</strong> is <strong>180</strong> times faster than the function just with <strong>for loop</strong> decorated by <strong>@jit</strong> and is just <strong>2</strong> times slower than the original highly optimized Numpy universal function.</p>
<p>Here there are 3 options for the argument <em>target</em>, “<strong>cpu</strong>“, “<strong>parallel</strong>“ and “<strong>cuda</strong>“. You should choose them with respect to the size of your data. </p>
<p>However, Numba also has its own limitations. It do not support list comprehension and do not support the infrence of any function in <strong>Numpy.random</strong>. So it’s not as good as we think when you actually use it. So I recommend that it’s really good for optimizing numerous <strong>for loop</strong> with easy matrix calculation. We could also expect that Numba will support more and more features in the future. Actually, in the next pre-release version, it said that they will support <strong>*Numpy.random</strong>.</p>
<p>Numba also supports some more powerful but experimental features, like <strong>auto parallel</strong>. To learn more about it, you could refer to the <a href="http://numba.pydata.org/numba-doc/0.35.0/user/jit.html" target="_blank" rel="external"><strong>doc</strong></a>. </p>
<h1 id="Cython"><a href="#Cython" class="headerlink" title="Cython"></a>Cython</h1><p>Now I am going to introduce Cython and I quite like Cython(Maybe just because I was using Cython for some time before I knew Numba). </p>
<p>The way Cython used to optimize Python code is more straightforward. It just try to translate the Python code with little modification into  C/C++ code. Then compile these code into <strong>Dynamic-link library(DLL)</strong>. After that, Python Interpreter could load this DLL library and use it!</p>
<p>So if you want to use Cython to speed up your code, you need to learn how to write Cython code.</p>
<p>It’s a little bit complicated than Numba, but it’s quite easy compared with using C/C++ directly.</p>
<p>I’d like to use the code listed previously to explain how to write Cython code.</p>
<pre><code>import numpy as np
cimport numpy as np
import cython

@cython.boundscheck(False)
@cython.wraparound(False)
cdef double _sum2d(np.ndarray[np.float32_t, ndim=2] arr):
    cdef int n, m
    n = arr.shape[0]
    m = arr.shape[1]
    cdef double ret = 0.0
    for i in range(n):
        for j in range(m):
            ret += arr[i, j]
    return ret

def sum2d(arr):
    return _sum2d(arr)
</code></pre><ul>
<li>The Filename Extension of Cython code is <strong>pyx</strong></li>
<li>Cython also has a sort of file like C header file ended with <strong>pxd</strong></li>
<li>The <strong>cimport</strong> is to import <strong>pxd</strong> file.</li>
<li>The two Cython decorators are to disable the bound check of Cython.</li>
<li>You could define the Cython function or variable in three ways:<ul>
<li><strong>cdef</strong>: Define function in the layer of <strong>pure</strong> C/C++ language.</li>
<li><strong>def</strong>: Define pure python function</li>
<li><strong>cpdef</strong>: Define function that is mixed with C/C++ and Python, whichs means that you could call or use it in C/C++ or Python easily with the cost of time.</li>
<li><strong>np.ndarray[np.float32_t, ndim=2]</strong> seems to be long, but it is a type just like <strong>int</strong> in C.</li>
<li>If you do not declare <strong>explicitly</strong> the type of function or variable, cython will regard it as a Python object.</li>
<li>Like listed previously, <strong>cdef</strong> defines a function in pure C/C++, we cannot call it directly from a Python program, so we use another interface(<strong>sum2d</strong>) to call it.</li>
</ul>
</li>
</ul>
<p>Still remember the basic idea of Cython?  Cython compiler need to translates/compiles the Cython code into C/C++ code that calls Python source code directly, then wrap it as a dynamic-link library. To make this, we need to write some instructions for compiling.</p>
<p>We call these intstructions <code>setup.py</code> conventionally.</p>
<pre><code># setup.py
from distutils.core import setup, Extension
from Cython.Build import cythonize
import numpy
setup(ext_modules = cythonize(Extension(
    &apos;filename&apos;,
    sources=[&apos;filename.pyx&apos;],
    language=&apos;c&apos;,
    include_dirs=[numpy.get_include()],
    library_dirs=[],
    libraries=[],
    extra_compile_args=[],
    extra_link_args=[]
)))
</code></pre><p>Here I list all the optional arguments, which makes it a little complex. I am going to explain each of them specifically.</p>
<ul>
<li><code>filename</code> here is the name of the <strong>DLL</strong>. Notice this name has to be <strong>exactly the same</strong> as the <strong>pyx</strong> file we’d like to compile.</li>
<li><code>sources</code> includes the Cython source code(.pyx) and the C/C++ code we want to call or wrap.</li>
<li><code>language</code> is the target layer of language, you could choose C/C++, default is C.</li>
<li><code>include_dirs</code> is the <code>-I</code> flag in gcc, which means add directory to include search path.</li>
<li><code>library_dirs</code> is the <code>-L</code> flag in gcc, which means add directory for library files.</li>
<li><code>libraries</code> is the <code>-l</code> flag in gcc, which means add directory for trying to link with a library file.</li>
<li><code>extra_compile_args</code> is the extra compile arguments for gcc, like you could pass <code>-std=c++11</code></li>
<li><code>extra_link_args</code> is the extra link arguments for gcc.</li>
</ul>
<p>Then we need to compile it with:</p>
<p><code>python setup.py build_ext --inplace</code></p>
<p>Then you could see <code>filename.c</code> and <code>filename.so</code> in the current directory. The first file is the C/C++ source code after compileing, the second is the <strong>DLL</strong>.</p>
<p>Then you could try to import it in a Python file:</p>
<pre><code>import filename
from filename import sum2d # Notice you cannot import _sum2d here since it&apos;s a cdef function
</code></pre><h3 id="Wrap-a-C-C-program"><a href="#Wrap-a-C-C-program" class="headerlink" title="Wrap a C/C++ program"></a>Wrap a C/C++ program</h3><p>Python is really a good glue to glue programs. But you need to do the interactions with Python API. Imagine you have a simulator code/solver code in C/C++ written by someone else and you want to call it from a Python code. Fortunately, Cython could help us do this!</p>
<p>Here we have a simulator of H.W.A written in C++ and we want to wrap it. We only need to do some minor modifications!</p>
<p>I just show the header file <code>Env.h</code> here, the <code>Env.cpp</code> is to large.</p>
<p><code>Env.h</code>:</p>
<pre><code>#include &lt;cstdio&gt;
#include &lt;string&gt;
#include &lt;cstring&gt;
#include &lt;algorithm&gt;
#include &lt;iostream&gt;

#include &lt;vector&gt;
#include &lt;map&gt;

class Env {
    public:
        int max;
        int step;
        int radius;
        int tot_reward;
        int row, col;
        double c1, c2, c3;
        double hemlock[107][128], establish_prob[107][128], distance[107][128];
        int establish_cost;
        int distance_cost;
        double predator_num[107][128];
        double prey_num[107][128], reverse_prey_num[107][128], old_predator_num[107][128], old_prey_num[107][128], prey_num_without_predator[107][128];
        int node_infest[107][128], node_protect[107][128];
        double total_reward;

        Env();
        Env(int row, int col);
        ~Env();
        void reset(int same);
        void Read_Numpy();
        double p_predator(int ux, int uy, int vx, int vy, bool is_long=false);
        double p_prey(int ux, int uy, int vx, int vy, bool is_long=false);
        void copy_map(double a[107][128], double b[107][128]);
        void breed_predator();
        void breed_prey();
        void prey_spread(int steps);
        void predator_spread(int steps);
        void pre_test();
        double get_test_result();
        void action_test(std::vector&lt;std::pair&lt;int, int&gt; &gt; &amp;action);
        void greedy_action(std::pair&lt;int, int&gt; action, int left);
        double action(std::pair&lt;int, int&gt; &amp;action);
        std::map&lt;std::pair&lt;int, int&gt;, int&gt; dump();
        //double[107][128] dump();
        std::map&lt;std::pair&lt;int, int&gt;, std::vector&lt;double&gt; &gt; current_state(bool pytorch=false);
        void reverse();
        std::vector&lt;std::pair&lt;int, int&gt; &gt; warmup();
        int done();

};
</code></pre><p>Now we need to implement a wrapper Cython program, we call it <code>Env_Cython.pyx</code></p>
<p><code>Env_Cython.pyx</code>:</p>
<pre><code>import numpy as np
cimport numpy as np
cimport cython
from libcpp.map cimport map
from libcpp.vector cimport vector
from libcpp.utility cimport pair
from libcpp.string cimport string
import os

cdef extern from &quot;Env.h&quot;:
    cdef cppclass Env:
        Env() except +
        Env(int, int) except +
        int row, col;
        void reset(int)
        void Read_Numpy()
        double p_predator(int, int, int, int, bool)
        map[pair[int, int], vector[double]] current_state()
        void predator_spread(int)
        void prey_spread(int)
        void pre_test()
        double get_test_result()
        void action_test(vector[pair[int, int]])
        void greedy_action(pair[int, int], int)
        double action(pair[int, int])
        map[pair[int, int], int] dump()
        void reverse()
        vector[pair[int, int]] warmup()
        int done()
</code></pre>
      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Python-Cython-Numba/" rel="tag"># Python, Cython, Numba</a>
          
        </div>
      

      
        
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/07/13/East-Hill-Flying-School/" rel="next" title="East Hill Flying School">
                <i class="fa fa-chevron-left"></i> East Hill Flying School
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Bai Yiwei</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    
    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  




  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("", "");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


  
  
  <!-- custom analytics part create by xiamo -->
<script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
<script>AV.initialize("", "");</script>
<script>
function showTime(Counter) {
	    var query = new AV.Query(Counter);
		    $(".leancloud_visitors").each(function() {
				        var url = $(this).attr("id").trim();
						        query.equalTo("url", url);
								        query.find({
											            success: function(results) {
															                if (results.length == 0) {
																				                    var content = '0 ' + $(document.getElementById(url)).text();
																									                    $(document.getElementById(url)).text(content);
																														                    return;
																																			                }
																																							                for (var i = 0; i < results.length; i++) {
																																												                    var object = results[i];
																																																	                    var content = object.get('time') + ' ' + $(document.getElementById(url)).text();
																																																						                    $(document.getElementById(url)).text(content);
																																																											                }
																																																															            },
																																																																		            error: function(object, error) {
																																																																						                console.log("Error: " + error.code + " " + error.message);
																																																																										            }
																																																																													        });

										    });
}

function addCount(Counter) {
	    var Counter = AV.Object.extend("Counter");
		    url = $(".leancloud_visitors").attr('id').trim();
			    title = $(".leancloud_visitors").attr('data-flag-title').trim();
				    var query = new AV.Query(Counter);
					    query.equalTo("url", url);
						    query.find({
								        success: function(results) {
											            if (results.length > 0) {
															                var counter = results[0];
																			                counter.fetchWhenSave(true);
																							                counter.increment("time");
																											                counter.save(null, {
																																                    success: function(counter) {
																																						                        var content =  counter.get('time') + ' ' + $(document.getElementById(url)).text();
																																												                        $(document.getElementById(url)).text(content);
																																																		                    },
																																																							                    error: function(counter, error) {
																																																													                        console.log('Failed to save Visitor num, with error message: ' + error.message);
																																																																			                    }
																																																																								                });
																															            } else {
																																			                var newcounter = new Counter();
																																							                newcounter.set("title", title);
																																											                newcounter.set("url", url);
																																															                newcounter.set("time", 1);
																																																			                newcounter.save(null, {
success: function(newcounter) {
	                        console.log("newcounter.get('time')="+newcounter.get('time'));
							                        var content = newcounter.get('time') + ' ' + $(document.getElementById(url)).text();
													                        $(document.getElementById(url)).text(content);
																			                    },
																								                    error: function(newcounter, error) {
																														                        console.log('Failed to create');
																																				                    }
																																									                });
																																																							            }
																																																										        },
																																																												        error: function(error) {
																																																															            console.log('Error:' + error.code + " " + error.message);
																																																																		        }
																																																																				    });
}
$(function() {
	    var Counter = AV.Object.extend("Counter");
		    if ($('.leancloud_visitors').length == 1) {
				        addCount(Counter);
						    } else if ($('.post-title-link').length > 1) {
								        showTime(Counter);
										    }
}); 
</script>



  
</body>
</html>
